-
script(defer).
  async function toggleSub(sub) {
    let thinger = document.getElementById(`thinger_${sub}`);
    if (thinger.innerText === 'unsubscribe') {
      await doThing(sub, 'unsubscribe');
    } else {
      await doThing(sub, 'subscribe');
    }
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
  }

  function getCsrfToken() {
    const meta = document.querySelector('meta[name="csrf-token"]');
    return meta ? meta.getAttribute("content") : "";
  }

  async function doThing(sub, thing) {
    const jwtToken = getCookie("auth_token");
    const response = await fetch(`/${thing}`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${jwtToken}`,
        'X-CSRF-Token': getCsrfToken(),
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ subreddit: sub }),
    });

    let thinger = document.getElementById(`thinger_${sub}`);
    if (thing === 'subscribe') {
      thinger.innerText = 'unsubscribe';
    } else {
      thinger.innerText = 'subscribe';
    }

    if (!response.ok) {
      console.error(response);
      console.error(`Failed to do ${thing}`);
    }
  }

  function toggleDetails(details_id) {
    var detailsElement = document.getElementById(details_id);
    if (detailsElement) {
      detailsElement.open = !detailsElement.open;
    }
  }

  // === SUBSCRIPTION MANAGEMENT FUNCTIONS ===

  // Toggle bulk add section visibility
  function toggleBulkAdd() {
    const bulkContainer = document.getElementById('bulk-add-container');
    if (bulkContainer.style.display === 'none') {
      bulkContainer.style.display = 'block';
      document.getElementById('bulk-input').focus();
    } else {
      bulkContainer.style.display = 'none';
    }
  }

  // Parse pasted content and create tags
  let bulkTags = new Set();

  document.addEventListener('DOMContentLoaded', () => {
    const bulkInput = document.getElementById('bulk-input');
    if (bulkInput) {
      bulkInput.addEventListener('paste', (e) => {
        setTimeout(() => parseAndTagify(), 100);
      });
      bulkInput.addEventListener('input', () => {
        parseAndTagify();
      });
    }
  });

  function parseAndTagify() {
    const input = document.getElementById('bulk-input');
    if (!input) return;

    const text = input.value;

    // Parse subreddit names: split by newlines, commas, spaces
    // Remove r/ prefix if present, clean whitespace
    const names = text
      .split(/[\n,\s]+/)
      .map(name => name.trim())
      .map(name => name.replace(/^r\//, ''))
      .filter(name => name.length > 0);

    // Update the set
    bulkTags = new Set(names);

    // Render tags
    renderBulkTags();
  }

  function renderBulkTags() {
    const container = document.getElementById('bulk-tags-container');
    if (!container) return;

    container.innerHTML = '';

    if (bulkTags.size === 0) return;

    bulkTags.forEach(tag => {
      const tagEl = document.createElement('span');
      tagEl.className = 'bulk-tag';
      tagEl.innerHTML = `r/${tag} <button onclick="removeTag('${tag}')">Ã—</button>`;
      container.appendChild(tagEl);
    });
  }

  function removeTag(tag) {
    bulkTags.delete(tag);
    renderBulkTags();
  }

  function clearBulkAdd() {
    document.getElementById('bulk-input').value = '';
    bulkTags.clear();
    renderBulkTags();
    document.getElementById('bulk-feedback').innerHTML = '';
  }

  async function processBulkAdd() {
    if (bulkTags.size === 0) {
      showBulkFeedback('Please enter at least one subreddit name', 'error');
      return;
    }

    const subreddits = Array.from(bulkTags);
    const jwtToken = getCookie("auth_token");
    const addBtn = document.getElementById('bulk-add-btn');

    addBtn.disabled = true;
    addBtn.innerText = 'Adding...';

    try {
      const response = await fetch('/subscribe-bulk', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${jwtToken}`,
          'X-CSRF-Token': getCsrfToken(),
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ subreddits }),
      });

      if (response.ok) {
        const results = await response.json();
        let message = '';

        if (results.added.length > 0) {
          message += `Added ${results.added.length} subscription(s). `;
        }
        if (results.skipped.length > 0) {
          message += `Skipped ${results.skipped.length} (already subscribed). `;
        }
        if (results.failed.length > 0) {
          message += `Failed ${results.failed.length}. `;
        }

        showBulkFeedback(message, 'success');

        // Reload page after 1.5s to show new subscriptions
        setTimeout(() => window.location.reload(), 1500);
      } else {
        showBulkFeedback('Failed to add subscriptions', 'error');
      }
    } catch (error) {
      console.error('Bulk add error:', error);
      showBulkFeedback('Network error occurred', 'error');
    } finally {
      addBtn.disabled = false;
      addBtn.innerText = 'Add Subscriptions';
    }
  }

  function showBulkFeedback(message, type) {
    const feedback = document.getElementById('bulk-feedback');
    feedback.innerHTML = message;
    feedback.className = type === 'error' ? 'bulk-feedback-error' : 'bulk-feedback-success';
  }

  // Filter subscriptions
  function filterSubs() {
    const query = document.getElementById('subs-filter').value.toLowerCase();
    const subs = document.querySelectorAll('.sub-title');

    subs.forEach(sub => {
      const subreddit = sub.getAttribute('data-subreddit').toLowerCase();
      if (subreddit.includes(query)) {
        sub.style.display = '';
      } else {
        sub.style.display = 'none';
      }
    });
  }

  // Unsubscribe all with confirmation
  function confirmUnsubscribeAll() {
    const confirmed = confirm('Are you sure you want to unsubscribe from ALL subreddits? This cannot be undone.');

    if (confirmed) {
      unsubscribeAll();
    }
  }

  async function unsubscribeAll() {
    const jwtToken = getCookie("auth_token");

    try {
      const response = await fetch('/unsubscribe-all', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${jwtToken}`,
          'X-CSRF-Token': getCsrfToken(),
          'Content-Type': 'application/json',
        },
      });

      if (response.ok) {
        const result = await response.json();
        alert(`Successfully removed ${result.count} subscription(s)`);
        window.location.reload();
      } else {
        alert('Failed to remove subscriptions');
      }
    } catch (error) {
      console.error('Unsubscribe all error:', error);
      alert('Network error occurred');
    }
  }

