include ../mixins/comment
include ../mixins/header
include ../mixins/head
include ../mixins/postUtils
include ../utils

- var post = data.post
- var comments = data.comments
- var postMedia = post.crosspost_parent_list && post.crosspost_parent_list.length > 0 ? post.crosspost_parent_list[0] : post
- var viewQuery = 'view=' + (query && query.view ? query.view : 'compact')
- var sortQuery = 'sort=' + (query && query.sort ? query.sort + (query.t ? '&t=' + query.t : '') : 'hot')
doctype html
html
  +head(post.title)
  script.
    function toggleDetails(details_id) {
      var detailsElement = document.getElementById(details_id);
      if (detailsElement) {
        detailsElement.open = !detailsElement.open;
      }
    }

  body(data-theme=user.themePreference data-classic-layout=user.useClassicLayout)
    main#content
      +header(user)
      div.hero
        h3.sub-title
          if from
            a(href=`${from}#${post.id}`) <- back
            | &nbsp;&nbsp;
            | ·
            | &nbsp;&nbsp;
          a(href=`/r/${post.subreddit}?${sortQuery}&${viewQuery}`) r/#{post.subreddit}

        div.info-container
          - var domain = post.url.startsWith('http') ? (new URL(post.url)).hostname : 'www.reddit.com'
          p
            | #{fmtnum(post.ups)} ↑
            | &nbsp;·&nbsp; by u/#{post.author}
            | &nbsp;·&nbsp;
            | #{timeDifference(Date.now(), post.created * 1000)}
            | &nbsp;·&nbsp;
            if domain !== 'www.reddit.com'
              a(href=`${post.url}`) submission url ↗
              | &nbsp;·&nbsp;
            a(href=`https://reddit.com${post.permalink}`) reddit ↗

        h2.post-title
          != post.title

        div.image-viewer.main-content
          if isPostGallery(post)
            div.gallery
              each item in postGalleryItems(post)
                div.gallery-item
                  a(href=`/media/${item.url}`)
                    img(src=item.url loading="lazy")
                  div.gallery-item-idx
                    | #{`${item.idx}/${item.total}`}
          else if isPostImage(post)
            a(href=`/media/${postMedia.url}`)
              img(src=postMedia.url).post-media
          else if isPostVideo(post)
            - var decodedVideos = decodePostVideoUrls(postMedia)
            - var videoSrc = decodedVideos[2] || decodedVideos[1]
            - var needsDash = !decodedVideos[2] && !!decodedVideos[1]
            video(controls data-dashjs-player=needsDash ? "" : null src=videoSrc).post-media
          else if isPostLink(post)
            a(href=post.url)
              | #{post.url}

        if postMedia.selftext_html
          div.self-text
            != convertInlineImageLinks(postMedia.selftext_html)

        hr

      div.comments-container
        - var total = comments.length
        each child, index in comments
          - var next_idx = index + 1
          - var prev_idx = index - 1
          - var next_com = next_idx < total ? comments[next_idx] : null
          - var prev_com = prev_idx >= 0 ? comments[prev_idx] : null
          - var next_id = next_com ? next_com.data.id : null
          - var prev_id = prev_com ? prev_com.data.id : null
          +comment(child, true, post.id, next_id, prev_id)
