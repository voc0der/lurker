include ../mixins/post
include ../mixins/header
include ../mixins/head
include ../utils
  - var viewQuery = query && query.view ? query.view : 'compact'
  - var sortQuery = query && query.sort ? query.sort + (query.t ? '&t=' + query.t : '') : 'hot'
  - var baseUrl = isHomePage ? '' : `/r/${subreddit}`
doctype html
html
  +head("home")
  include ../mixins/subUtils

  body(data-theme=user.themePreference data-classic-layout=user.useClassicLayout)
    main#content
      +header(user)
      div.hero
        div.sub-title
          h1
            if isMulti
              a(href=`/?sort=${sortQuery}&view=${viewQuery}`) lurker
            else
              a(href=`/r/${subreddit}?sort=${sortQuery}&view=${viewQuery}`)
                | r/#{subreddit}
          if !isMulti
            div#button-container
              if isSubbed
                button(onclick=`toggleSub('${subreddit}')` id=`thinger_${subreddit}`) unsubscribe
              else
                button(onclick=`toggleSub('${subreddit}')` id=`thinger_${subreddit}`) subscribe
        if about && !isMulti
          div.about #{about.public_description}
        if about && !isMulti
          div.info-container
            p
              | #{fmtnum(about.accounts_active)} active
              | &nbsp;·&nbsp;
              | #{fmtnum(about.subscribers)} subscribers
        hr
        details.sort-details
          summary.sorting sorting by #{query.sort + (query.t?' '+query.t:'')}
          div.sort-opts
            div
              a(href=`${baseUrl}?sort=hot&view=${viewQuery}`) hot
            div
              a(href=`${baseUrl}?sort=new&view=${viewQuery}`) new
            div
              a(href=`${baseUrl}?sort=rising&view=${viewQuery}`) rising
            div
              a(href=`${baseUrl}?sort=top&view=${viewQuery}`) top
            div
              a(href=`${baseUrl}?sort=top&t=day&view=${viewQuery}`) top day
            div
              a(href=`${baseUrl}?sort=top&t=week&view=${viewQuery}`) top week
            div
              a(href=`${baseUrl}?sort=top&t=month&view=${viewQuery}`) top month
            div
              a(href=`${baseUrl}?sort=top&t=year&view=${viewQuery}`) top year
            div
              a(href=`${baseUrl}?sort=top&t=all&view=${viewQuery}`) top all
        details.view-details
          summary.viewing viewing as #{viewQuery}
          div.view-opts
            div
              a(href=`${baseUrl}?sort=${sortQuery}&view=compact`) compact
            div
              a(href=`${baseUrl}?sort=${sortQuery}&view=card`) card

      div#posts-container
        if posts
          each child in posts.posts
            +post(child.data, currentUrl)

      if posts && posts.after
        if user.infiniteScroll
          div.page-divider ─────
          div#infinite-scroll-sentinel
          div#loading-indicator Loading more posts...
        else
          div.footer
            div.footer-item
              - var newQuery = {...query, after: posts.after}
              a(href=`/r/${subreddit}?${encodeQueryParams(newQuery)}`) next ⟶

      if user.infiniteScroll && posts && posts.after
        script.
          (function() {
            let isLoading = false;
            let afterCursor = '#{posts.after}';
            const subreddit = '#{subreddit}';
            const sort = '#{query.sort}';
            const view = '#{query.view}';
            const currentUrl = '#{currentUrl}';

            const sentinel = document.getElementById('infinite-scroll-sentinel');
            const loadingIndicator = document.getElementById('loading-indicator');
            const postsContainer = document.getElementById('posts-container');

            const observer = new IntersectionObserver(async (entries) => {
              if (entries[0].isIntersecting && !isLoading && afterCursor) {
                isLoading = true;
                loadingIndicator.style.display = 'block';

                try {
                  const params = new URLSearchParams({
                    sort: sort,
                    view: view,
                    after: afterCursor,
                    currentUrl: currentUrl
                  });

                  const response = await fetch(`/api/r/${subreddit}/posts?${params}`);
                  const data = await response.json();

                  if (data.html) {
                    // Add divider before new content
                    const divider = document.createElement('div');
                    divider.className = 'page-divider';
                    divider.textContent = '─────';
                    postsContainer.insertAdjacentElement('beforeend', divider);

                    // Add new posts
                    postsContainer.insertAdjacentHTML('beforeend', data.html);
                  }

                  afterCursor = data.after;

                  if (!afterCursor) {
                    observer.disconnect();
                    sentinel.remove();
                    loadingIndicator.textContent = 'No more posts';
                    loadingIndicator.style.display = 'block';
                  }
                } catch (error) {
                  console.error('Error loading more posts:', error);
                  loadingIndicator.textContent = 'Error loading posts';
                } finally {
                  loadingIndicator.style.display = 'none';
                  isLoading = false;
                }
              }
            }, { threshold: 0.1 });

            if (sentinel) {
              observer.observe(sentinel);
            }
          })();
